<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pedidos – Visor STL 3D</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

body {
  margin: 0;
  background: radial-gradient(circle at top, #1b1b1b, #0a0a0a);
  color: #eaeaea;
  height: 100vh;
  overflow: hidden;
}

.screen {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: opacity .4s ease, transform .4s ease;
}
.hidden {
  opacity: 0;
  pointer-events: none;
  transform: scale(.97);
}

.upload-box {
  background: #151515;
  padding: 50px;
  border-radius: 22px;
  width: 100%;
  max-width: 420px;
  text-align: center;
}

.btn {
  width: 100%;
  padding: 16px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, #1565C0, #42A5F5);
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  margin-top: 12px;
}

.file {
  margin-top: 15px;
  color: #6dd3ff;
  opacity: 0;
}
.file.show { opacity: 1; }

input { display: none; }

.viewer {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

canvas {
  background: #050505;
  border-radius: 18px;
}
</style>
</head>

<body>

<!-- UPLOAD -->
<div class="screen" id="uploadScreen">
  <div class="upload-box">
    <h1>Subir STL</h1>
    <input type="file" id="fileInput" accept=".stl">
    <button class="btn" id="uploadBtn">Seleccionar archivo</button>
    <div class="file" id="fileName"></div>
    <button class="btn" id="viewBtn" style="display:none">Visualizar</button>
  </div>
</div>

<!-- VIEWER -->
<div class="screen hidden" id="viewerScreen">
  <div class="viewer">
    <canvas id="canvas"></canvas>
  </div>
</div>

<script>
const uploadScreen = document.getElementById('uploadScreen');
const viewerScreen = document.getElementById('viewerScreen');
const uploadBtn = document.getElementById('uploadBtn');
const viewBtn = document.getElementById('viewBtn');
const fileInput = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

uploadBtn.onclick = () => fileInput.click();

fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file || !file.name.endsWith('.stl')) return;

  const reader = new FileReader();
  reader.onload = e => {
    const bytes = new Uint8Array(e.target.result);
    let bin = '';
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    localStorage.setItem('stl-binary', btoa(bin));

    fileName.textContent = `✔ ${file.name}`;
    fileName.classList.add('show');
    viewBtn.style.display = 'block';
  };
  reader.readAsArrayBuffer(file);
};

viewBtn.onclick = () => {
  uploadScreen.classList.add('hidden');
  viewerScreen.classList.remove('hidden');
  renderSTL();
};

function renderSTL() {
  const size = Math.min(window.innerWidth, window.innerHeight) * 0.85;
  canvas.width = size;
  canvas.height = size;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,size,size);
  ctx.translate(size/2, size/2);

  const base64 = localStorage.getItem('stl-binary');
  if (!base64) return;

  const buffer = Uint8Array.from(atob(base64), c => c.charCodeAt(0)).buffer;
  const view = new DataView(buffer);

  const faces = view.getUint32(80, true);
  let offset = 84;
  const tris = [];

  for (let i = 0; i < faces; i++) {
    offset += 12;
    const v = [];
    for (let j = 0; j < 3; j++) {
      const x = view.getFloat32(offset, true); offset += 4;
      const y = view.getFloat32(offset, true); offset += 4;
      const z = view.getFloat32(offset, true); offset += 4;
      v.push({ x, y, z });
    }
    offset += 2;
    tris.push(v);
  }

  let minX=Infinity,maxX=-Infinity;
  let minY=Infinity,maxY=-Infinity;
  let minZ=Infinity,maxZ=-Infinity;

  tris.flat().forEach(p=>{
    minX=Math.min(minX,p.x); maxX=Math.max(maxX,p.x);
    minY=Math.min(minY,p.y); maxY=Math.max(maxY,p.y);
    minZ=Math.min(minZ,p.z); maxZ=Math.max(maxZ,p.z);
  });

  const scale = size * 0.45 / Math.max(maxX-minX, maxY-minY);
  const depth = scale * 0.7;

  const light = { x: 0.3, y: 0.4, z: 1 };

  function project(p){
    const x=p.x-(minX+maxX)/2;
    const y=p.y-(minY+maxY)/2;
    const z=p.z-(minZ+maxZ)/2;
    return {
      x:(x-y)*scale,
      y:(x+y)*scale*0.5 - z*depth,
      z
    };
  }

  const facesProj = tris.map(t=>{
    const p = t.map(project);
    const ux = t[1].x - t[0].x;
    const uy = t[1].y - t[0].y;
    const uz = t[1].z - t[0].z;
    const vx = t[2].x - t[0].x;
    const vy = t[2].y - t[0].y;
    const vz = t[2].z - t[0].z;

    const nx = uy*vz - uz*vy;
    const ny = uz*vx - ux*vz;
    const nz = ux*vy - uy*vx;

    const nl = Math.hypot(nx,ny,nz) || 1;
    const nd = Math.max(0,
      (nx*light.x + ny*light.y + nz*light.z) / nl
    );

    const zavg = p.reduce((s,q)=>s+q.z,0)/3;
    return { p, nd, zavg };
  });

  facesProj.sort((a,b)=>a.zavg-b.zavg);

  facesProj.forEach(f=>{
    ctx.beginPath();
    f.p.forEach((q,i)=>i?ctx.lineTo(q.x,q.y):ctx.moveTo(q.x,q.y));
    ctx.closePath();
    const shade = Math.floor(180 + f.nd * 70);
    ctx.fillStyle = `rgb(${shade},${shade+10},255)`;
    ctx.fill();
  });
}
</script>

</body>
</html>
